sequenceDiagram
    participant User
    participant ProjectDir as ".project-name"
    participant FileSystem as "Target Directory"
    participant AuthKey as "auth_key"
    
    %% Locking process
    User->>ProjectDir: Check if auth_key exists
    ProjectDir-->>User: Exists? (Yes/No)
    alt Auth key missing
        ProjectDir->>AuthKey: Generate secure auth_key
        AuthKey-->>ProjectDir: Store auth_key
    end
    User->>FileSystem: Iterate over files
    FileSystem->>AuthKey: Derive per-file key (HMAC)
    FileSystem->>FileSystem: Generate random nonce/IV
    FileSystem->>FileSystem: Encrypt file content (AEAD)
    FileSystem-->>FileSystem: Store ciphertext + nonce + metadata
    FileSystem-->>User: All files processed
    User->>ProjectDir: Mark directory as locked (.lock or metadata)

    %% Unlocking process
    User->>ProjectDir: Read auth_key
    ProjectDir-->>User: Return auth_key
    User->>FileSystem: Iterate over encrypted files
    FileSystem->>AuthKey: Derive per-file key (HMAC)
    FileSystem->>FileSystem: Extract nonce + ciphertext
    FileSystem->>FileSystem: Decrypt with AEAD
    FileSystem->>FileSystem: Verify authenticity
    FileSystem-->>FileSystem: Restore original file
    FileSystem-->>User: All files processed
    User->>ProjectDir: Mark directory as unlocked (.lock removed)
